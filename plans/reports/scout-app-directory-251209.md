# App Directory Scout Report - AI Section Generator
**Date**: 2025-12-09 | **Project**: AI Section Generator (Shopify App)

---

## Overview

Complete architectural analysis of `/app` directory. Tech stack: React Router, Prisma ORM, Google Gemini AI, Shopify Admin API, Polaris Web Components.

**Total Files Scanned**: 90+ files across routes, services, components, and types.

---

## 1. CORE APPLICATION FILES

### Root Entry Points

#### `/app/root.tsx`
- **Purpose**: React Router document root wrapper
- **Exports**: Default React component
- **Key Features**: 
  - HTML document structure with Shopify CDN links (Inter fonts)
  - Polaris stylesheet CDN integration
  - Outlet for nested routes
- **Dependencies**: react-router

#### `/app/entry.server.tsx`
- **Purpose**: Server-side entry point for SSR streaming
- **Exports**: `handleRequest()`, `streamTimeout`
- **Key Functions**:
  - `handleRequest()`: Pipes React DOM to Response stream
  - Adds bot detection (isbot) for crawlers
  - Handles shell errors and timeouts
- **Dependencies**: react-dom/server, react-router, @shopify/shopify-app-react-router

#### `/app/routes.ts`
- **Purpose**: Route configuration export (auto-generated by React Router)
- **Usage**: Referenced by build system

### Configuration Files

#### `/app/shopify.server.ts` (Server Config)
- **Purpose**: Shopify app initialization and auth setup
- **Exports**: `shopify`, `apiVersion`, `authenticate`, `addDocumentResponseHeaders`, `registerWebhooks`, `sessionStorage`
- **Key Config**:
  - API Version: October25 (2025-10)
  - API Key: from env
  - Session Storage: PrismaSessionStorage (SQLite/custom DB)
  - Distribution: AppStore
  - Custom shop domains supported
- **Dependencies**: @shopify/shopify-app-react-router, Prisma

#### `/app/db.server.ts`
- **Purpose**: Prisma client singleton (with hot-reload protection)
- **Exports**: Default Prisma client
- **Pattern**: Global singleton with dev-mode prevention of multiple instances
- **Usage**: Imported by all data-access services
- **Dependencies**: @prisma/client

---

## 2. ROUTES (17 Total)

### App Layout Routes

#### `/app/routes/app.tsx` (Main App Layout)
- **Loader**: Authenticates admin user, returns `apiKey`
- **UI**: AppProvider wrapper with Polaris `<s-app-nav>`
- **Navigation**:
  - Home (/)
  - Sections (/app/sections)
  - Templates (/app/templates)
  - Billing (/app/billing)
- **Error Handling**: ErrorBoundary with Shopify boundary utilities
- **Dependencies**: authenticate, AppProvider

#### `/app/routes/app._index.tsx` (Homepage)
- **Purpose**: Dashboard showing activity and onboarding
- **Loader**: 
  - Fetches stats (sections count, templates count, weekly generations)
  - Fetches shop settings (onboarding state)
- **Action**: `dismissOnboarding` intent
- **Components Rendered**:
  - SetupGuide (with onboarding state)
  - FeatureNav (navigation cards)
  - QuickStats (activity sidebar)
- **Services Used**: settingsService
- **Database Queries**: section count, sectionTemplate count, shopSettings

### Section Generation Routes

#### `/app/routes/app.sections.new.tsx` (Generate Section)
- **Purpose**: Main generation interface (AI prompt -> code -> save)
- **Loader**: Fetches available themes from Shopify
- **Actions** (5 intents):
  1. `generate`: Call AI, return code (no DB save yet)
  2. `saveDraft`: Save generated code to DB with status "draft"
  3. `save`: Save to theme + DB with status "saved"
  4. `saveAsTemplate`: Create reusable template from generation
- **Key Logic**:
  - Quota check before generation
  - Section name extracted from schema or provided by user
  - Two-step save flow: Draft -> Publish or Direct publish
  - Usage tracking on successful save
- **Services Used**: 
  - aiAdapter (generation)
  - themeAdapter (save to theme)
  - sectionService (DB save)
  - templateService (template creation)
  - canGenerate, trackGeneration (usage tracking)

#### `/app/routes/app.sections._index.tsx` (Section History)
- **Purpose**: View/manage all generated sections
- **Loader**: 
  - Fetches sections with pagination, filtering, search, sorting
  - Supports view types: all, active (saved), draft (generated), archived
  - Multi-status filtering via comma-separated URL param
- **Actions** (3 intents):
  1. `toggleFavorite`: Mark/unmark as favorite
  2. `delete`: Delete single section
  3. `bulkDelete`: Delete up to 50 sections at once
- **URL Params**: page, view, status, favorites, search, sort
- **Services Used**: sectionService
- **Components**: SectionsEmptyState, DeleteConfirmModal

#### `/app/routes/app.sections.$id.tsx` (Section Detail)
- **Purpose**: View/edit individual section
- **Status**: Defined but not fully examined

### Template Routes

#### `/app/routes/app.templates.tsx` (Template Library)
- **Purpose**: Manage section templates (quick-start generators)
- **Loader**: 
  - Auto-seeds default templates on first visit via templateSeeder
  - Fetches templates filtered by category and favorites
- **Actions** (4 intents):
  1. `create`: New custom template
  2. `update`: Edit template
  3. `toggleFavorite`: Mark as favorite
  4. `delete`: Remove template
- **Components**: TemplateGrid, TemplateEditorModal, FilterButtonGroup
- **Services Used**: templateService, templateSeeder

### Billing Routes

#### `/app/routes/app.billing.tsx` (Billing & Plans)
- **Purpose**: Subscription management and plan selection
- **Loader**: 
  - Fetches active plans, current subscription, quota check
  - Handles approval status from return URL (status/charge_id params)
- **Actions**:
  - `subscribe`: Create subscription via Shopify Billing API
  - `cancelSubscription`: Cancel current subscription
- **Return URL**: Redirects back to /app/billing after approval
- **Services Used**: 
  - getActivePlans, getSubscription, createSubscription, cancelSubscription, checkQuota
- **Components**: PlanSelector, UsageDashboard, UsageAlertBanner

### Authentication Routes

#### `/app/routes/auth.$.tsx`
- **Purpose**: Catch-all auth route for OAuth callbacks

#### `/app/routes/auth.login/route.tsx`
- **Purpose**: Login entry point

#### `/app/routes/auth.login/error.server.tsx`
- **Purpose**: Handle login errors

### Webhook Routes

#### `/app/routes/webhooks.app.uninstalled.tsx`
- **Purpose**: Handle app uninstall webhook

#### `/app/routes/webhooks.app.scopes_update.tsx`
- **Purpose**: Handle scopes change webhook

#### `/app/routes/webhooks.app.subscriptions_update.tsx`
- **Purpose**: Handle subscription status changes
- **Trigger**: When subscription status changes (active, cancelled, expired)
- **Services Used**: billing.server (updateSubscriptionStatus, fetchCurrentPeriodEnd)

### Public & API Routes

#### `/app/routes/_index/route.tsx`
- **Purpose**: Public landing page (before install)

#### `/app/routes/app.additional.tsx`
- **Purpose**: Additional page

#### `/app/routes/api.files.tsx`
- **Purpose**: API endpoint for fetching shop files/images
- **Services Used**: filesService
- **Response**: JSON list of files with pagination

#### `/app/routes/app.api.resource.tsx`
- **Purpose**: API endpoint for fetching shop resources (products, collections, articles)
- **Services Used**: shopifyDataService
- **Query Params**: resourceType, id

---

## 3. SERVICES (15 Total)

### AI & Generation Services

#### `/app/services/ai.server.ts`
- **Class**: `AIService implements AIServiceInterface`
- **Methods**:
  - `generateSection(prompt)`: Call Gemini 2.5 Flash
  - `getMockSection(prompt)`: Fallback mock section
- **System Prompt**: 137-line Liquid section generation rules
- **Features**:
  - Schema block with settings
  - CSS scoping with section ID
  - Plain text labels (no translation keys)
  - URL/button defaults required
  - Max 25 char section names
- **Export**: `aiService` singleton
- **Dependencies**: @google/generative-ai

#### `/app/services/theme.server.ts`
- **Class**: `ThemeService implements ThemeServiceInterface`
- **Constants**: `SECTION_PREFIX = 'bsm-'`
- **Methods**:
  - `getThemes(request)`: Fetch first 10 themes
  - `createSection(request, themeId, fileName, content, sectionName?)`: Upsert section
- **Helpers**:
  - `truncateName(name, maxLength=25)`: Enforce Shopify 25-char limit
  - `updateSchemaName(liquidCode, newName)`: Parse & update schema JSON
- **File Path**: `sections/bsm-{filename}.liquid`
- **Export**: `themeService` singleton

#### `/app/services/section.server.ts`
- **Export**: `sectionService` object
- **Methods**:
  - `create(input)`: Save new section to DB
  - `getByShop(shop, options)`: Paginated list with filters
  - `getById(id, shop)`: Single section
  - `update(id, shop, input)`: Update fields
  - `toggleFavorite(id, shop)`: Mark as favorite
  - `delete(id, shop)`: Remove section
  - `getMostRecent(shop)`: Latest section
- **Helpers**:
  - `extractSchemaName(liquidCode)`: Parse JSON schema
  - `generateDefaultName(prompt)`: Truncate to 50 chars
- **DB Model**: section (Prisma)

#### `/app/services/adapters/ai-adapter.ts`
- **Class**: `AIAdapter implements AIServiceInterface`
- **Pattern**: Adapter wrapping aiService
- **Export**: `aiAdapter` singleton

#### `/app/services/adapters/theme-adapter.ts`
- **Class**: `ThemeAdapter implements ThemeServiceInterface`
- **Pattern**: Adapter wrapping themeService
- **Export**: `themeAdapter` singleton

### Template & Template Management Services

#### `/app/services/template.server.ts`
- **Export**: `templateService` object
- **Methods**:
  - `create(input)`: Save new template
  - `getByShop(shop, options)`: Fetch templates
  - `getById(id, shop)`: Single template
  - `update(id, shop, input)`: Edit template
  - `toggleFavorite(id, shop)`: Mark favorite
  - `delete(id, shop)`: Remove template
  - `duplicate(id, shop)`: Clone template
- **DB Model**: sectionTemplate (Prisma)

#### `/app/services/template-seeder.server.ts`
- **Export**: `templateSeeder` object
- **Methods**:
  - `hasTemplates(shop)`: Check if seeded
  - `seedDefaultTemplates(shop)`: One-time seed
  - `resetToDefaults(shop)`: Delete & re-seed
  - `getDefaultTemplateCount()`: Count of defaults
- **Data Source**: ../data/default-templates
- **Pattern**: Auto-runs on first /templates visit

### Billing & Usage Services

#### `/app/services/billing.server.ts`
- **Model**: Hybrid (base recurring + usage overages)
- **Key Functions**:
  - `createSubscription(admin, input)`: Create sub via Shopify
  - `cancelSubscription(admin, shop)`: Cancel active sub
  - `recordUsage(admin, input)`: Log generation for billing
  - `checkQuota(shop)`: Check remaining quota
  - `getSubscription(shop)`: Active subscription lookup
  - `updateSubscriptionStatus(shopifySubId, status)`: Webhook callback
  - `changeSubscription(admin, input)`: Upgrade/downgrade
- **DB Models**: Subscription, UsageRecord, PlanConfiguration (Prisma)
- **Free Tier**: 5 generations
- **Error Handling**: Graceful degradation (doesn't block generation on billing failure)

#### `/app/services/usage-tracking.server.ts`
- **Functions**:
  - `canGenerate(shop)`: Check if merchant can generate
  - `trackGeneration(admin, shop, sectionId, prompt)`: Record generation
  - `getUsageSummary(shop)`: Usage overview
- **Dependencies**: billing.server

### Shopify Data Services

#### `/app/services/shopify-data.server.ts`
- **Class**: `ShopifyDataService`
- **Features**:
  - 10-minute TTL caching
  - Transforms GraphQL responses to mock Liquid objects
  - Handles GID normalization
- **Methods**:
  - `getProduct(request, productId)`: Fetch product data
  - `getCollection(request, collectionId)`: Fetch collection
  - `getArticle(request, articleId)`: Fetch blog article
  - `getShop(request)`: Fetch shop info
  - `clearCache()`: Flush cached data
  - `invalidateCache(type, id)`: Clear specific entry
- **Export**: `shopifyDataService` singleton
- **Usage**: Preview rendering needs real shop data

#### `/app/services/files.server.ts`
- **Class**: `FilesService`
- **Methods**:
  - `getFiles(request, options)`: Paginated file list
- **Filters**: IMAGE media type only
- **Pagination**: Cursor-based
- **Export**: `filesService` singleton
- **Usage**: Image picker in section settings

### Shop Settings Services

#### `/app/services/settings.server.ts`
- **Export**: `settingsService` object
- **Methods**:
  - `get(shop)`: Fetch shop settings
  - `markHistoryViewed(shop)`: Update onboarding step
  - `dismissOnboarding(shop)`: Hide onboarding guide
- **DB Model**: shopSettings (Prisma)

---

## 4. TYPES (4 Files)

### `/app/types/index.ts`
- **Pattern**: Barrel export for type definitions

### `/app/types/service.types.ts`
- **Types**:
  - SectionType, AIGenerationOptions, AIGenerationResult
  - AIServiceInterface, ThemeServiceInterface
  - GeneratedSectionRecord, GenerateActionData, SaveActionData

### `/app/types/shopify-api.types.ts`
- **Types**: Theme, ThemeEdge, ThemeFile, UserError, ThemeFilesUpsertResponse

### `/app/types/billing.ts`
- **Types**:
  - PlanTier (starter, growth, professional)
  - SubscriptionStatus, ChargeStatus
  - PlanConfig, CreateSubscriptionInput, QuotaCheck
  - SubscriptionUpdateWebhook, ApproachingCappedAmountWebhook
- **Re-exports**: Prisma types

---

## 5. COMPONENTS (60+ Files)

### Generation Components
- GenerateLayout (two-column layout)
- PromptInput, SectionNameInput, SectionTypeSelector
- AdvancedOptions, TemplateSuggestions, PromptExamples
- GenerateActions, GenerateInputColumn, GeneratePreviewColumn
- CodePreview, SaveTemplateModal
- LoadingState, EmptyState

### Home/Dashboard Components
- QuickStats, FeatureNav, SetupGuide

### Section History Components
- HistoryTable, HistoryPreviewModal
- SectionsEmptyState, DeleteConfirmModal

### Template Components
- TemplateGrid, TemplateCard, TemplateEditorModal

### Billing Components
- PlanSelector, PlanCard
- UsageDashboard, UsageAlertBanner
- QuotaProgressBar

### Preview/Rendering Components (30+ files)
- SectionPreview, PreviewFrame, PreviewToolbar
- PreviewSkeleton, PreviewErrorBoundary
- ResourceSelector, SelectedResourceDisplay
- SettingsPanel, SettingField
- Settings: Text, Number, Checkbox, Radio, Select, Color, Image, TextAlignment, Font, Video, Product, Collection, Article, Page, LinkList
- Drops (8 files): ShopifyDrop, ProductDrop, VariantDrop, CollectionDrop, ArticleDrop, ImageDrop, BlockDrop, ShopDrop
- Schema parser & hooks: parseSchema, usePreviewMessaging, useResourceDetection, useResourceFetcher

### Shared Components
- Banner, Button, Card, EmptyState, FilterButtonGroup

---

## 6. FEATURE FLAGS & UTILITIES

### `/app/services/flags/feature-flags.ts`
- **Enum**: FeatureFlagKey
- **Flags**: ENABLE_SECTION_HISTORY, ENABLE_TEMPLATE_LIBRARY, ENABLE_AI_SETTINGS, CACHE_THEME_LIST, VERBOSE_LOGGING
- **Pattern**: Record of FeatureFlag objects

### `/app/services/flags/flag-utils.ts`
- Feature flag utility functions

---

## 7. GLOBALS

#### `/app/globals.d.ts`
- Global TypeScript declarations (Polaris Web Components types, window globals)

---

## ARCHITECTURE SUMMARY

### Data Flow
```
User Input (Route)
  ↓
Action Handler (services/adapters)
  ↓
Service Layer (ai, theme, section, billing)
  ↓
Database (Prisma ORM)
  ↓
Component Rendering (React Router + Polaris Web)
```

### Key Patterns
- **Adapter**: AIAdapter, ThemeAdapter
- **Service**: sectionService, templateService, billingService
- **Singleton**: aiService, themeService, shopifyDataService, filesService
- **Factory**: templateSeeder
- **Observer**: usePreviewMessaging

### Tech Stack
- React Router v7, React 19
- Polaris Web Components
- Google Generative AI (Gemini 2.5 Flash)
- Node.js, Prisma ORM
- Shopify Admin API (GraphQL)
- App Bridge, Session Storage

### Authentication & Authorization
- OAuth via shopify.server.ts
- PrismaSessionStorage (persistent)
- Multi-shop support (shop param in all contexts)

### Database Models (Prisma)
1. Session (OAuth sessions)
2. Section (id, shop, prompt, code, status, themeId, fileName, isFavorite)
3. SectionTemplate (title, description, category, icon, prompt, code, isFavorite)
4. Subscription (shop, planName, status, basePrice, usageThisCycle, overagesThisCycle)
5. UsageRecord (shop, sectionId, amount, chargeStatus, idempotencyKey)
6. PlanConfiguration (planName, displayName, basePrice, includedQuota, overagePrice)
7. ShopSettings (shop, onboardingDismissed, hasViewedHistory)
8. FailedUsageCharge (shop, sectionId, errorMessage)

### Security
- Multi-tenant (all queries filtered by shop)
- Ownership verification (section/template updates check shop)
- Idempotency keys (usage charges prevent duplicates)
- Graceful degradation (billing failures don't block generation)
- Error handling (safe user errors, logged system errors)

---

## UNRESOLVED QUESTIONS

1. Exact webhook handling implementation
2. Auth routes OAuth flow details
3. Preview rendering engine specifics
4. GraphQL schema field mappings validation
5. Error boundary recovery patterns
6. Component composition details (large components partially read)
7. Mock data structure location
8. CSS/styling approach
9. Environment configuration loading
10. Billing webhook handling complete flow

---

## RECOMMENDATIONS

1. Create architecture diagram (services, data flow)
2. Document preview rendering (Liquid execution)
3. Add API endpoint documentation
4. Document billing webhook flow
5. Add component prop JSDoc
6. Document GraphQL query patterns
7. Create example user flows
8. Document template default seed data
9. Create troubleshooting guide
10. Document plan configuration seeding

