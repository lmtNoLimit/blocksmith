// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Session model for Shopify OAuth (MongoDB requires dual ID pattern)
model Session {
  session_id    String    @id @default(auto()) @map("_id") @db.ObjectId
  id            String    @unique // Shopify session ID (e.g., "offline_shop.myshopify.com")
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop])
}

// Section model for AI-generated theme sections
model Section {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  shop      String
  name      String? // User-friendly section name (auto-generated from prompt if not provided)
  prompt    String
  code      String // Generated Liquid code
  themeId   String? // Theme it was saved to (if saved)
  themeName String?
  fileName  String?

  // Generation metadata
  tone  String? // professional, casual, friendly
  style String? // minimal, bold, elegant

  // Status
  status     String  @default("generated") // generated, saved, error
  isFavorite Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([shop])
  @@index([createdAt])
  @@index([status])
}

// Section templates for reusable prompts and generated code
model SectionTemplate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  shop        String // Merchant who owns template
  title       String
  description String
  category    String // marketing, product, content, layout
  icon        String // Emoji or icon identifier
  prompt      String // Original generation prompt
  code        String? // Liquid code (optional - can be prompt-only)
  isFavorite  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shop])
  @@index([category])
}

// Shop-level settings (onboarding, preferences)
model ShopSettings {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  shop                  String    @unique

  // Onboarding tracking (manual toggle states)
  hasGeneratedSection   Boolean   @default(false) // Step 1: manually marked complete
  hasSavedTemplate      Boolean   @default(false) // Step 2: manually marked complete
  hasConfiguredSettings Boolean   @default(false) // Step 3: Configure Settings tracking
  hasViewedHistory      Boolean   @default(false) // Deprecated: kept for backward compatibility
  onboardingDismissed   Boolean   @default(false)
  ctaDismissedAt        DateTime? // Track when CTA was dismissed

  // User preferences
  defaultTone           String    @default("professional")
  defaultStyle          String    @default("minimal")
  autoSaveEnabled       Boolean   @default(false)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// News/announcements for dashboard display
model News {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  url         String? // Optional link for "Read more"
  type        String    @default("update") // update, feature, announcement
  isActive    Boolean   @default(true)
  publishedAt DateTime  @default(now())
  expiresAt   DateTime? // Optional expiry
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive, publishedAt])
}

// Subscription tracking for Shopify App Billing
model Subscription {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  shop             String // Multiple subscriptions per shop allowed (pending, active, cancelled)
  shopifySubId     String    @unique // Shopify GraphQL subscription ID (e.g., gid://shopify/AppSubscription/123)
  planName         String // starter, growth, professional
  status           String // active, cancelled, expired, pending
  currentPeriodEnd DateTime
  trialEndsAt      DateTime? // Free trial end date (null if no trial)

  // Pricing
  basePrice     Float // Monthly base charge (USD)
  includedQuota Int // Included generations per billing cycle
  overagePrice  Float // Price per additional generation (USD)
  cappedAmount  Float // Max overage charge (USD)

  // Usage tracking (current billing cycle)
  usageThisCycle    Int @default(0)
  overagesThisCycle Int @default(0)

  // Cache Shopify usage line item ID for faster charge recording
  usageLineItemId String? // Shopify usage line item GID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop, status, createdAt])
  @@index([status])
  @@index([currentPeriodEnd])
}

// Usage records sent to Shopify for billing
model UsageRecord {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  shop           String
  subscriptionId String @db.ObjectId // Link to Subscription model
  sectionId      String @db.ObjectId // Link to Section
  idempotencyKey String @unique // Prevent duplicate charges: ${shop}-${generationId}-${timestamp}

  // Charge details
  amount       Float // Charge amount (USD)
  description  String // "Section generation - Hero banner"
  billingCycle DateTime // Which billing cycle this belongs to

  // Shopify API response
  shopifyChargeId String? // Shopify usage charge ID (null if not yet sent)
  chargeStatus    String  @default("pending") // pending, accepted, declined, error
  errorMessage    String? // If charge failed

  createdAt DateTime  @default(now())
  sentAt    DateTime? // When sent to Shopify

  @@index([shop])
  @@index([subscriptionId])
  @@index([chargeStatus])
  @@index([createdAt])
}

// Plan configuration (pricing tiers)
model PlanConfiguration {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  planName    String @unique // starter, growth, professional
  displayName String // "Starter", "Growth", "Professional"
  description String // Short description for UI

  // Pricing
  basePrice     Float // Monthly base charge (USD)
  includedQuota Int // Included generations
  overagePrice  Float // Price per overage generation
  cappedAmount  Float // Max total monthly charge

  // Features
  features String[] // Array of feature descriptions for UI

  // Display
  badge     String? // "Popular", "Best Value" (null if none)
  sortOrder Int     @default(0) // Display order (lower = first)
  isActive  Boolean @default(true) // Can merchants subscribe?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
}

// Failed usage charges for recovery/reconciliation
model FailedUsageCharge {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  shop         String
  sectionId    String    @db.ObjectId
  errorMessage String
  retryCount   Int       @default(0)
  createdAt    DateTime  @default(now())
  retriedAt    DateTime?

  @@index([shop])
  @@index([createdAt])
  @@index([retryCount])
}

// AI Conversation for iterative section refinement
model Conversation {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  sectionId String @unique @db.ObjectId // 1:1 with Section
  shop      String

  // AI Context
  systemPrompt String? // Custom system prompt override (null = use default)
  modelId      String  @default("gemini-2.5-flash") // AI model used

  // Metadata
  title        String? // Auto-generated from first message
  messageCount Int     @default(0)
  totalTokens  Int     @default(0) // Cumulative token usage

  // Status
  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages Message[]

  @@index([shop])
  @@index([createdAt])
}

// Individual chat message
model Message {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String @db.ObjectId

  // Message content
  role    String // "user" | "assistant" | "system"
  content String // Message text (can include Liquid code blocks)

  // Code extraction
  codeSnapshot String? // Extracted Liquid code from this message (if any)

  // Metadata
  tokenCount Int? // Tokens in this message
  modelId    String? // Model that generated this (for assistant messages)

  // UI-only fields (not sent to AI)
  isError      Boolean @default(false) // Was this an error response?
  errorMessage String? // Error details if isError

  createdAt DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}
